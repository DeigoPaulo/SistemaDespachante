{% extends 'base.html' %}

{% block title %}Configurações do Escritório{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="d-flex align-items-center mb-4">
                <h2 class="fw-bold mb-0"><i class="fas fa-cogs text-secondary me-2"></i> Configurações do Sistema</h2>
            </div>

            <form method="POST" class="card shadow-sm border-0">
                {% csrf_token %}
                
                <div class="card-header bg-dark text-white py-3">
                    <h5 class="mb-0"><i class="fas fa-percent me-2"></i> Impostos e Taxas Variáveis (%)</h5>
                </div>
                <div class="card-body p-4">
                    <div class="row g-4">
                        
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-uppercase small">Alíquota Total de Impostos</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0 text-primary cursor-help" 
                                      data-bs-toggle="tooltip" 
                                      data-bs-placement="top" 
                                      title="Insira a porcentagem total que você paga sobre a Nota Fiscal. Ex: 6,00% (Simples Anexo III), 15,50% (Simples Anexo V) ou ~16,33% (Lucro Presumido).">
                                    <i class="fas fa-info-circle"></i>
                                </span>
                                
                                <input type="text" name="aliquota_imposto" 
                                       class="form-control form-control-lg mask-percent border-start-0" 
                                       value="{{ despachante.aliquota_imposto }}" required>
                                       
                                <span class="input-group-text bg-light text-dark fw-bold">%</span>
                            </div>
                            <div class="form-text mt-2 text-muted" style="font-size: 0.85rem;">
                                <i class="fas fa-calculator me-1"></i>
                                O sistema usará este valor para calcular seu <strong>Lucro Líquido</strong>.
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold text-uppercase small">Taxa de Cartão / Operacional</label>
                            <div class="input-group">
                                <input type="text" name="taxa_bancaria_padrao" class="form-control form-control-lg mask-percent" 
                                       value="{{ despachante.taxa_bancaria_padrao }}" required>
                                <span class="input-group-text bg-light text-dark fw-bold">%</span>
                            </div>
                            <div class="form-text mt-2">Custo médio de maquininha ou taxas bancárias.</div>
                        </div>
                    </div>
                </div>

                <div class="card-header bg-secondary text-white py-3 border-top">
                    <h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i> Valores Fixos por Processo (R$)</h5>
                </div>
                <div class="card-body p-4 bg-light">
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <label class="form-label fw-bold text-uppercase text-success"><i class="fas fa-hand-holding-usd me-1"></i> Honorário Padrão (Orçamentos)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-success text-white border-end-0">R$</span>
                                <input type="text" name="valor_honorario_padrao" class="form-control form-control-lg mask-money border-success border-start-0 fw-bold text-success" 
                                       value="{{ despachante.valor_honorario_padrao|floatformat:2 }}" required>
                            </div>
                            <div class="form-text">Este valor virá preenchido automaticamente ao criar um novo orçamento (você poderá alterar na hora).</div>
                        </div>
                    </div>

                    <hr class="text-muted opacity-25">

                    <div class="alert alert-info border-0 shadow-sm d-flex align-items-center mb-4">
                        <i class="fas fa-info-circle me-3"></i>
                        <div class="small">
                            As taxas abaixo são descontadas do lucro em <strong>todo processo aprovado</strong>. Você define qual serviço usa a taxa reduzida na tela de "Cadastro de Serviços".
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-uppercase small text-dark">Taxa SINDEGO (Padrão)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white text-muted border-end-0">R$</span>
                                <input type="text" name="valor_taxa_sindego_padrao" class="form-control mask-money border-start-0" 
                                       value="{{ despachante.valor_taxa_sindego_padrao|floatformat:2 }}" required>
                            </div>
                            <div class="form-text mt-2">Valor cobrado na maioria dos processos (Ex: 13,00).</div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold text-uppercase small text-dark">Taxa SINDEGO (Reduzida)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white text-muted border-end-0">R$</span>
                                <input type="text" name="valor_taxa_sindego_reduzida" class="form-control mask-money border-start-0" 
                                       value="{{ despachante.valor_taxa_sindego_reduzida|floatformat:2 }}" required>
                            </div>
                            <div class="form-text mt-2">Para serviços específicos (Ex: 6,50).</div>
                        </div>
                    </div>
                </div>

                <div class="card-header bg-warning text-dark py-3 border-top">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i> Integração Automática (Asaas)</h5>
                </div>
                <div class="card-body p-4 bg-light bg-opacity-25">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <label class="form-label fw-bold">Sua Chave de API (Produção)</label>
                            <input type="text" name="asaas_api_key" class="form-control font-monospace border-warning" 
                                   value="{{ despachante.asaas_api_key|default:'' }}" 
                                   placeholder="$aact_... (Cole aqui a chave gerada no Asaas)" autocomplete="off">
                            <div class="form-text text-muted mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Para habilitar o botão de gerar boletos, crie uma conta no <strong>Asaas.com</strong>, vá em <em>Minha Conta > Integrações</em>, gere a chave e cole acima.
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="alert alert-warning border-0 small shadow-sm">
                                <strong>Como funciona?</strong><br>
                                O dinheiro dos boletos gerados cairá <strong>diretamente na sua conta Asaas</strong>. Este sistema apenas cria a cobrança para você.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-footer bg-white p-4 border-top-0">
                    <button type="submit" class="btn btn-primary btn-lg px-5 fw-bold shadow-sm w-100">
                        <i class="fas fa-save me-2"></i> Salvar Todas as Configurações
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
    $(document).ready(function(){
        // 1. Máscaras de Input
        $('.mask-percent').mask('00,00', {reverse: true});
        $('.mask-money').mask('#.##0,00', {reverse: true});

        // 2. Inicialização dos Tooltips do Bootstrap (Necessário para o ícone de info funcionar)
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    });
</script>
{% endblock %}