{% extends 'base.html' %}
{% load static %}

{% block title %}Novo Cliente{% endblock %}

{% block content %}

<div class="card shadow mt-4 mb-5">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="fas fa-user-plus me-2"></i> Cadastro de Cliente
        </h5>
    </div>

    <div class="card-body">
        <form method="post" id="form-cadastro-cliente" class="form-confirm" data-msg="Confirma o cadastro?">
            {% csrf_token %}

            <div class="row mb-3">
                <div class="col-md-8">
                    <label class="form-label">Nome Completo</label>
                    <input type="text" name="cliente_nome" id="nome" class="form-control text-uppercase" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">CPF / CNPJ</label>
                    <input type="text" name="cliente_cpf_cnpj" id="id_cpf_cnpj" class="form-control mask-cpf-cnpj" required>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label">RG</label>
                    <input type="text" name="rg" class="form-control text-uppercase">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Órgão Expedidor</label>
                    <input type="text" name="orgao_expedidor" class="form-control text-uppercase" placeholder="Ex: SSP, SPTC">
                </div>
                <div class="col-md-2">
                    <label class="form-label">UF RG</label>
                    <select name="uf_rg" class="form-select">
                        <option value="GO" selected>GO</option>
                        <option value="DF">DF</option>
                        <option value="SP">SP</option>
                        <option value="MG">MG</option>
                        <option value="TO">TO</option>
                        <option value="MT">MT</option>
                        <option value="MS">MS</option>
                        <option value="BA">BA</option>
                        <option value="">Outro</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Profissão</label>
                    <input type="text" name="profissao" class="form-control text-uppercase">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-12">
                    <label class="form-label">Filiação (Mãe/Pai)</label>
                    <input type="text" name="filiacao" class="form-control text-uppercase" placeholder="Nome da Mãe (Preferencialmente)">
                </div>
            </div>

            <h6 class="text-muted mt-4 border-bottom pb-2">Endereço</h6>

            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label">CEP</label>
                    <input type="text" name="cep" id="cep" class="form-control mask-cep">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Rua</label>
                    <input type="text" name="rua" id="rua" class="form-control text-uppercase">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Número</label>
                    <input type="text" name="numero" id="numero" class="form-control">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label">Bairro</label>
                    <input type="text" name="bairro" id="bairro" class="form-control text-uppercase">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Cidade</label>
                    <input type="text" name="cidade" id="cidade" class="form-control text-uppercase" value="GOIÂNIA">
                </div>
                <div class="col-md-2">
                    <label class="form-label">UF</label>
                    <input type="text" name="uf" id="uf" class="form-control text-uppercase" value="GO">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Complemento</label>
                    <input type="text" name="complemento" class="form-control text-uppercase">
                </div>
            </div>

            <h6 class="text-muted mt-4 border-bottom pb-2">Contato</h6>

            <div class="row mb-4">
                <div class="col-md-4">
                    <label class="form-label">Telefone</label>
                    <input type="text" name="cliente_telefone" id="telefone" class="form-control mask-phone">
                </div>
                <div class="col-md-8">
                    <label class="form-label">E-mail</label>
                    <input type="email" name="cliente_email" class="form-control lowercase">
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-5 mb-3">
                <h6 class="text-success fw-bold mb-0"><i class="fas fa-car me-2"></i> Frota / Veículos</h6>
                <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#modalVeiculo">
                    <i class="fas fa-plus-circle me-1"></i> Adicionar Veículo
                </button>
            </div>

            <div class="table-responsive mb-4">
                <table class="table table-bordered table-hover" id="tabela-veiculos-visual">
                    <thead class="table-light small">
                        <tr>
                            <th style="width: 15%;">Placa</th>
                            <th>Modelo</th>
                            <th>Marca</th>
                            <th>Cor</th>
                            <th>Ano Fab/Mod</th>
                            <th>Tipo</th>
                            <th style="width: 50px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="linha-vazia">
                            <td colspan="7" class="text-center text-muted small py-2">Nenhum veículo adicionado.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="veiculos-inputs-container"></div>

            <div class="d-flex justify-content-end gap-2 mt-4">
                <a href="{% url 'dashboard' %}" class="btn btn-secondary">Voltar</a>
                <button type="submit" class="btn btn-success px-4">
                    <i class="fas fa-save me-2"></i> Salvar Cliente e Veículos
                </button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="modalVeiculo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Adicionar Veículo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Placa <span class="text-danger">*</span></label>
                        <input type="text" id="pop_placa" class="form-control mask-placa text-uppercase fw-bold text-center" maxlength="8">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">RENAVAM</label>
                        <input type="text" id="pop_renavam" class="form-control mask-number">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Chassi</label>
                        <input type="text" id="pop_chassi" class="form-control text-uppercase">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tipo</label>
                        <select id="pop_tipo" class="form-select">
                            <option value="CARRO">Carro</option>
                            <option value="MOTO">Moto</option>
                            <option value="CAMINHAO">Caminhão</option>
                            <option value="REBOQUE">Reboque</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Marca</label>
                        <input type="text" id="pop_marca" class="form-control text-uppercase">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Modelo</label>
                        <input type="text" id="pop_modelo" class="form-control text-uppercase">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Cor</label>
                        <input type="text" id="pop_cor" class="form-control text-uppercase">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Ano Fab.</label>
                        <input type="text" id="pop_ano_fabricacao" class="form-control mask-year">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Ano Mod.</label>
                        <input type="text" id="pop_ano_modelo" class="form-control mask-year">
                    </div>
                </div>
                <div class="alert alert-danger mt-3 d-none" id="msg-erro-modal">Preencha a Placa corretamente.</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-success" id="btn-add-modal">Incluir na Lista</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/custom.js' %}"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var btnAdd = document.getElementById('btn-add-modal');
        
        // Sobrescreve/Adiciona evento clique especificamente para esta tela
        if (btnAdd) {
            btnAdd.onclick = function() {
                // 1. Pega valores
                var placa = document.getElementById('pop_placa').value.toUpperCase();
                var renavam = document.getElementById('pop_renavam').value;
                var chassi = document.getElementById('pop_chassi').value.toUpperCase();
                var marca = document.getElementById('pop_marca').value.toUpperCase();
                var modelo = document.getElementById('pop_modelo').value.toUpperCase();
                var cor = document.getElementById('pop_cor').value.toUpperCase();
                var tipo = document.getElementById('pop_tipo').value;
                var anoFab = document.getElementById('pop_ano_fabricacao').value;
                var anoMod = document.getElementById('pop_ano_modelo').value;

                // 2. Valida
                if (!placa || placa.length < 7) {
                    document.getElementById('msg-erro-modal').classList.remove('d-none');
                    return;
                }
                document.getElementById('msg-erro-modal').classList.add('d-none');

                // 3. Adiciona na Tabela Visual
                var tbody = document.querySelector('#tabela-veiculos-visual tbody');
                var linhaVazia = document.getElementById('linha-vazia');
                if (linhaVazia) linhaVazia.remove();

                var tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="fw-bold text-primary">${placa}</td>
                    <td>${modelo}</td>
                    <td>${marca}</td>
                    <td>${cor}</td>
                    <td>${anoFab}/${anoMod}</td>
                    <td>${tipo}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-danger btn-remove-item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);

                // 4. Cria Inputs Ocultos para o POST
                var container = document.getElementById('veiculos-inputs-container');
                var divHidden = document.createElement('div');
                divHidden.innerHTML = `
                    <input type="hidden" name="veiculo_placa[]" value="${placa}">
                    <input type="hidden" name="veiculo_renavam[]" value="${renavam}">
                    <input type="hidden" name="veiculo_chassi[]" value="${chassi}">
                    <input type="hidden" name="veiculo_marca[]" value="${marca}">
                    <input type="hidden" name="veiculo_modelo[]" value="${modelo}">
                    <input type="hidden" name="veiculo_cor[]" value="${cor}">
                    <input type="hidden" name="veiculo_tipo[]" value="${tipo}">
                    <input type="hidden" name="veiculo_ano_fabricacao[]" value="${anoFab}">
                    <input type="hidden" name="veiculo_ano_modelo[]" value="${anoMod}">
                `;
                container.appendChild(divHidden);

                // 5. Botão Remover
                tr.querySelector('.btn-remove-item').onclick = function() {
                    tr.remove();
                    divHidden.remove();
                    if (tbody.children.length === 0) {
                        tbody.innerHTML = '<tr id="linha-vazia"><td colspan="7" class="text-center text-muted small py-2">Nenhum veículo adicionado.</td></tr>';
                    }
                };

                // 6. Limpa e Fecha
                document.querySelectorAll('#modalVeiculo input').forEach(input => input.value = '');
                var modalEl = document.getElementById('modalVeiculo');
                var modalInstance = bootstrap.Modal.getInstance(modalEl);
                modalInstance.hide();
            };
        }
    });
</script>
{% endblock %}