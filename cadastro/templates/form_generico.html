{% extends 'base.html' %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        
        <div class="card shadow border-0 mt-4 mb-5">
            <div class="card-header bg-primary text-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-pen-square me-2"></i> {{ titulo }}
                </h5>
                
                {% if form.instance.pk and url_excluir %}
                    {% if user.is_superuser or user.perfilusuario.tipo_usuario == 'ADMIN' %}
                        <button type="button" class="btn btn-danger btn-sm text-white border border-light" data-bs-toggle="modal" data-bs-target="#modalExcluir">
                            <i class="fas fa-trash-alt me-1"></i> Excluir
                        </button>
                    {% endif %}
                {% endif %}
            </div>

            <div class="card-body p-4">
                <form method="post" enctype="multipart/form-data"> {% csrf_token %}

                    {# --- CAMPOS OCULTOS --- #}
                    <input type="hidden" name="custo_impostos" value="{{ form.custo_impostos.value|stringformat:'s'|default:'0' }}">
                    <input type="hidden" name="custo_taxa_bancaria" value="{{ form.custo_taxa_bancaria.value|stringformat:'s'|default:'0' }}">

                    {# ================================================================= #}
                    {#  1. BLOCO DE CONTROLE (AMARELO SUAVE)                             #}
                    {# ================================================================= #}
                    {% if form.status or form.numero_atendimento or form.responsavel %}
                    <div class="card mb-4 shadow-sm border-0" style="background-color: #fffdf5; border-left: 4px solid #ffc107 !important;">
                        <div class="card-body">
                            <h6 class="text-muted fw-bold text-uppercase mb-3 small">
                                <i class="fas fa-tasks text-warning me-2"></i> Controle Operacional
                            </h6>
                            <div class="row g-3">
                                {% if form.status %}
                                <div class="col-md-4">
                                    <label class="form-label fw-bold text-dark small text-uppercase">Status</label>
                                    {{ form.status }}
                                    {% if form.status.errors %}
                                        <div class="text-danger small">{{ form.status.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                {% endif %}

                                {% if form.numero_atendimento %}
                                <div class="col-md-4">
                                    <label class="form-label fw-bold text-dark small text-uppercase">Nº Atendimento</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white text-warning border-end-0"><i class="fas fa-hashtag"></i></span>
                                        {{ form.numero_atendimento }}
                                    </div>
                                </div>
                                {% endif %}

                                {% if form.responsavel %}
                                <div class="col-md-4">
                                    <label class="form-label fw-bold text-dark small text-uppercase">Responsável</label>
                                    {{ form.responsavel }}
                                </div>
                                {% endif %}
                                
                                {# --- CAMPO DE PENDÊNCIA (SÓ APARECE SE STATUS FOR PENDENTE) --- #}
                                {% if form.motivo_pendencia %}
                                <div class="col-12 mt-3" id="div-motivo-pendencia" style="display: none;">
                                    <label class="form-label fw-bold text-danger small text-uppercase">
                                        <i class="fas fa-exclamation-triangle me-1"></i> Motivo da Pendência (Obrigatório)
                                    </label>
                                    {{ form.motivo_pendencia }}
                                    <div class="form-text text-muted small">Esse texto aparecerá em destaque para o cliente no link de rastreio.</div>
                                </div>
                                {% endif %}

                                {# --- LINK DE RASTREIO --- #}
                                {% if form.instance.token_rastreio %}
                                <div class="col-12 mt-4 pt-3 border-top border-warning border-opacity-25">
                                    <label class="form-label fw-bold text-dark small text-uppercase">
                                        <i class="fas fa-share-alt me-1"></i> Link Público do Cliente
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control bg-white" id="linkRastreio" 
                                               value="{{ request.scheme }}://{{ request.get_host }}{% url 'rastreio_publico' form.instance.token_rastreio %}" readonly>
                                        
                                        <button class="btn btn-outline-secondary" type="button" onclick="copiarLink()">
                                            <i class="fas fa-copy"></i> Copiar
                                        </button>
                                        
                                        {% if form.instance.cliente.telefone %}
                                        <a href="https://wa.me/55{{ form.instance.cliente.telefone|cut:' '|cut:'-'|cut:'('|cut:')' }}?text=Olá, acompanhe o andamento do seu processo aqui: {{ request.scheme }}://{{ request.get_host }}{% url 'rastreio_publico' form.instance.token_rastreio %}" 
                                           target="_blank" class="btn btn-success text-white fw-bold">
                                            <i class="fab fa-whatsapp"></i> Enviar
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {# ================================================================= #}
                    {#  1.5 OBSERVAÇÕES GERAIS (NOVO BLOCO)                              #}
                    {# ================================================================= #}
                    {% if form.observacoes_internas %}
                    <div class="mb-4">
                        <label class="form-label fw-bold small text-uppercase text-muted">Observações Internas</label>
                        {{ form.observacoes_internas }}
                        <div class="form-text small text-muted">Anotações visíveis apenas para a equipe do escritório.</div>
                    </div>
                    {% endif %}

                    {# ================================================================= #}
                    {#  2. BLOCO FINANCEIRO (VERDE SUAVE)                                #}
                    {# ================================================================= #}
                    {% if form.valor_honorarios %}
                    <div class="card mb-4 shadow-sm border-0" style="background-color: #f8fffa; border-left: 4px solid #198754 !important;">
                        <div class="card-body">
                            <h6 class="text-muted fw-bold text-uppercase mb-3 small">
                                <i class="fas fa-wallet text-success me-2"></i> Gestão Financeira
                            </h6>
                            
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-dark small text-uppercase">Taxas (Repasse)</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white text-danger border-end-0">R$</span>
                                        {{ form.valor_taxas_detran }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold text-dark small text-uppercase">Honorários (Lucro)</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white text-success border-end-0">R$</span>
                                        {{ form.valor_honorarios }}
                                    </div>
                                </div>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold text-dark small text-uppercase">Quem pagou?</label>
                                    {{ form.quem_pagou_detran }}
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold text-dark small text-uppercase">Situação</label>
                                    {{ form.status_financeiro }}
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold text-dark small text-uppercase">Data Baixa</label>
                                    {{ form.data_pagamento }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {# ================================================================= #}
                    {#  3. RESTANTE DOS CAMPOS                                           #}
                    {# ================================================================= #}
                    {% for field in form %}
                        {% if field.name not in 'status,numero_atendimento,responsavel,valor_taxas_detran,valor_honorarios,quem_pagou_detran,status_financeiro,data_pagamento,custo_impostos,custo_taxa_bancaria,motivo_pendencia,observacoes_internas' %}
                            <div class="mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label fw-bold small text-uppercase text-muted">
                                    {{ field.label }}
                                    {% if field.field.required %} <span class="text-danger">*</span> {% endif %}
                                </label>
                                
                                {% if field.field.widget.attrs.class %}
                                    {{ field }}
                                {% elif "Select" in field.field.widget.constructor_name %}
                                    <div class="input-group">{{ field }}</div>
                                {% else %}
                                    {{ field }}
                                {% endif %}

                                {% if field.help_text %}
                                    <div class="form-text text-muted small">{{ field.help_text|safe }}</div>
                                {% endif %}
                                {% if field.errors %}
                                    <div class="text-danger small mt-1"><i class="fas fa-exclamation-circle me-1"></i> {{ field.errors.0 }}</div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4 border-top pt-3">
                        <a href="{{ url_voltar|default:'javascript:history.back()' }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-arrow-left me-1"></i> Voltar
                        </a>
                        <button type="submit" class="btn btn-success px-4 shadow fw-bold">
                            <i class="fas fa-save me-1"></i> Salvar Alterações
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{# Modal de Exclusão (Mantido igual) #}
{% if form.instance.pk and url_excluir %}
    {% if user.is_superuser or user.perfilusuario.tipo_usuario == 'ADMIN' %}
        <div class="modal fade" id="modalExcluir" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i> Confirmar Exclusão</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>{{ texto_modal|default:"Tem certeza que deseja excluir este registro permanentemente?" }}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <form action="{{ url_excluir }}" method="POST">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">Sim, Excluir</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endif %}

{% block extra_js %}
<script>
    if (typeof jQuery === 'undefined') {
        document.write('<script src="https://code.jquery.com/jquery-3.7.1.min.js"><\/script>');
        document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"><\/script>');
    }
</script>

<script>
    // --- FUNÇÃO DE COPIAR LINK ---
    function copiarLink() {
        var copyText = document.getElementById("linkRastreio");
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value).then(function() {
            var btn = event.target.closest('button');
            var original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
            btn.classList.replace('btn-outline-secondary', 'btn-success');
            setTimeout(function() {
                btn.innerHTML = original;
                btn.classList.replace('btn-success', 'btn-outline-secondary');
            }, 2000);
        });
    }

    $(document).ready(function(){
        // 1. MÁSCARA DINHEIRO
        if ($('.mask-money').length > 0) $('.mask-money').mask('000.000.000,00', {reverse: true});

        // 2. LÓGICA DE MOSTRAR/OCULTAR MOTIVO PENDÊNCIA
        const $selectStatus = $('select[name="status"]');
        const $divPendencia = $('#div-motivo-pendencia');
        
        function verificarStatus() {
            if($selectStatus.val() === 'PENDENTE') {
                $divPendencia.slideDown();
                // Opcional: focar no campo se estiver vazio
                if($divPendencia.find('textarea').val() === '') $divPendencia.find('textarea').focus();
            } else {
                $divPendencia.slideUp();
            }
        }

        if ($selectStatus.length) {
            $selectStatus.change(verificarStatus);
            verificarStatus();
        }

        // 3. CÁLCULO CUSTOS
        const ALIQUOTA_PERCENTUAL = parseFloat("{{ user.perfilusuario.despachante.aliquota_imposto|default:0|stringformat:'f' }}".replace(',', '.'));
        const TAXA_PERCENTUAL = parseFloat("{{ user.perfilusuario.despachante.taxa_bancaria_padrao|default:0|stringformat:'f' }}".replace(',', '.'));
        const $inputHonorarios = $('input[name="valor_honorarios"]');
        const $hiddenImposto = $('input[name="custo_impostos"]');
        const $hiddenTaxa = $('input[name="custo_taxa_bancaria"]');

        function calcularCustos() {
            let valor = $inputHonorarios.val() || '0';
            let honorario = parseFloat(valor.replace(/\./g, '').replace(',', '.'));
            
            let imposto = honorario * (ALIQUOTA_PERCENTUAL / 100);
            let taxa = honorario * (TAXA_PERCENTUAL / 100);

            $hiddenImposto.val(imposto.toFixed(2));
            $hiddenTaxa.val(taxa.toFixed(2));
        }

        if ($inputHonorarios.length) {
            $inputHonorarios.on('input change', calcularCustos);
        }
    });
</script>
{% endblock %}
{% endblock %}