{% extends 'base.html' %}
{% load static %}

{% block title %}Novo Veículo{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        
        <div class="card shadow border-0 mt-4 mb-5">
            <div class="card-header bg-success text-white py-3">
                <h5 class="mb-0">
                    <i class="fas fa-car me-2"></i> Cadastro de Veículo
                </h5>
            </div>

            <div class="card-body p-4">
                
                <div class="bg-light p-3 mb-4 rounded border shadow-sm">
                    <h6 class="text-primary fw-bold small text-uppercase mb-2">
                        <i class="fas fa-search me-1"></i> Preenchimento Automático (Tabela Fipe)
                    </h6>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="small text-muted mb-1">1. Marca</label>
                            <select id="fipe_marca" class="form-select form-select-sm select2-field">
                                <option value="">Digite para buscar...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="small text-muted mb-1">2. Modelo</label>
                            <select id="fipe_modelo" class="form-select form-select-sm select2-field" disabled>
                                <option value="">Aguardando Marca...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="small text-muted mb-1">3. Ano</label>
                            <select id="fipe_ano" class="form-select form-select-sm select2-field" disabled>
                                <option value="">Aguardando Modelo...</option>
                            </select>
                        </div>
                    </div>
                </div>
                <form method="post">
                    {% csrf_token %}

                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Placa <span class="text-danger">*</span></label>
                            {{ form.placa }}
                            <div class="text-danger small">{{ form.placa.errors.0 }}</div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">RENAVAM</label>
                            {{ form.renavam }}
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Chassi</label>
                            {{ form.chassi }}
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Tipo</label>
                            {{ form.tipo }}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Marca</label>
                            {{ form.marca }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Modelo</label>
                            {{ form.modelo }}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Cor</label>
                            {{ form.cor }}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Ano Fab.</label>
                            {{ form.ano_fabricacao }}
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Ano Mod.</label>
                            {{ form.ano_modelo }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Proprietário (Cliente)</label>
                            {{ form.cliente }}
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                        <a href="{% url 'dashboard' %}" class="btn btn-secondary px-4">
                            <i class="fas fa-arrow-left me-1"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-success px-4 shadow">
                            <i class="fas fa-save me-1"></i> Salvar Veículo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{% static 'js/custom.js' %}"></script>

<script>
$(document).ready(function() {
    
    // --- INICIALIZAÇÃO DO SELECT2 (CAMPO DE BUSCA) ---
    $('.select2-field').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: 'Pesquise ou selecione...',
        language: {
            noResults: function() { return "Nenhum resultado encontrado"; },
            searching: function() { return "Buscando..."; }
        }
    });

    // URLs da API Pública
    const urlBase = 'https://parallelum.com.br/fipe/api/v1/carros/marcas';
    
    // Elementos (Objetos jQuery)
    const $selMarca = $('#fipe_marca');
    const $selModelo = $('#fipe_modelo');
    const $selAno = $('#fipe_ano');

    // Campos do Django
    const $inputMarca = $('#id_marca');
    const $inputModelo = $('#id_modelo');
    const $inputAnoMod = $('#id_ano_modelo');
    const $inputAnoFab = $('#id_ano_fabricacao');

    // 1. Carregar Marcas ao abrir
    $.getJSON(urlBase, function(data) {
        $.each(data, function(key, val) {
            $selMarca.append(new Option(val.nome, val.codigo));
        });
    }).fail(function() {
        console.error("Erro ao carregar FIPE");
    });

    // 2. Quando mudar a Marca -> Carrega Modelos
    $selMarca.on('change', function() {
        let codMarca = $(this).val();
        
        // Limpa e Desabilita
        $selModelo.empty().append('<option value="">Carregando...</option>').prop('disabled', true).trigger('change');
        $selAno.empty().append('<option value="">Aguardando...</option>').prop('disabled', true).trigger('change');

        if (!codMarca) return;

        $.getJSON(`${urlBase}/${codMarca}/modelos`, function(data) {
            $selModelo.empty().append('<option value="">Selecione o Modelo...</option>');
            
            $.each(data.modelos, function(key, val) {
                $selModelo.append(new Option(val.nome, val.codigo));
            });
            
            $selModelo.prop('disabled', false).trigger('change'); // Atualiza Select2

            // Preenche input Django
            let nomeMarca = $selMarca.find('option:selected').text();
            if($inputMarca.length) $inputMarca.val(nomeMarca.toUpperCase());
        });
    });

    // 3. Quando mudar o Modelo -> Carrega Anos
    $selModelo.on('change', function() {
        let codModelo = $(this).val();
        let codMarca = $selMarca.val();

        // Evita disparo falso quando limpamos o campo via JS
        if (!codModelo || codModelo === "") return;

        $selAno.empty().append('<option value="">Carregando...</option>').prop('disabled', true).trigger('change');

        $.getJSON(`${urlBase}/${codMarca}/modelos/${codModelo}/anos`, function(data) {
            $selAno.empty().append('<option value="">Selecione o Ano...</option>');
            
            $.each(data, function(key, val) {
                $selAno.append(new Option(val.nome, val.codigo));
            });
            
            $selAno.prop('disabled', false).trigger('change');

            // Preenche input Django
            let nomeModelo = $selModelo.find('option:selected').text();
            if($inputModelo.length) $inputModelo.val(nomeModelo.toUpperCase());
        });
    });

    // 4. Quando selecionar o Ano -> Preenche tudo
    $selAno.on('change', function() {
        let codAno = $(this).val();
        let codMarca = $selMarca.val();
        let codModelo = $selModelo.val();

        if (!codAno || codAno === "") return;

        $.getJSON(`${urlBase}/${codMarca}/modelos/${codModelo}/anos/${codAno}`, function(data) {
            // Preenche Campos
            if($inputAnoMod.length) $inputAnoMod.val(data.AnoModelo);
            if($inputAnoFab.length) $inputAnoFab.val(data.AnoModelo);

            // Aviso visual opcional (Toast ou Alert)
            // alert(`Veículo carregado: ${data.Modelo} \nValor FIPE: ${data.Valor}`);
        });
    });

});
</script>
{% endblock %}