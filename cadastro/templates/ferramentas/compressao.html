{% extends 'base.html' %}
{% load static %}

{% block title %}Otimizar PDF - DespachaPro{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        
        <div class="text-center mb-4 mt-4">
            <h2 class="fw-bold text-primary"><i class="fas fa-compress-alt me-2"></i>Otimizar PDF</h2>
            <p class="text-muted">Reduza o tamanho e remova dados ocultos dos seus documentos.</p>
        </div>

        <div class="card shadow-lg border-0 rounded-4">
            <div class="card-body p-5">
                
                <form method="post" enctype="multipart/form-data" id="formCompressao">
                    {% csrf_token %}
                    
                    <div class="mb-4 text-center p-5 border-2 border-dashed rounded-3 bg-light" 
                         style="border-style: dashed; border-color: #cbd5e1; cursor: pointer;"
                         onclick="document.getElementById('{{ form.arquivo_pdf.id_for_label }}').click()">
                        
                        <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                        <br>
                        <h5 class="text-dark fw-bold">Clique para selecionar</h5>
                        <p class="text-muted small">ou arraste o arquivo aqui</p>
                        
                        <div class="d-none">
                            {{ form.arquivo_pdf }}
                        </div>
                        
                        <div id="file-name" class="mt-3 badge bg-info text-dark d-none p-2"></div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-success py-3 fw-bold rounded-pill shadow-sm" id="btnComprimir">
                            <i class="fas fa-magic me-2"></i> Otimizar e Baixar
                        </button>
                    </div>

                </form>

                <div id="loadingArea" class="text-center mt-4 d-none">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2 text-muted fw-bold animate__animated animate__pulse animate__infinite">
                        Processando arquivo...
                    </p>
                </div>

            </div>
        </div>
        
        <div class="alert alert-light mt-3 text-center border shadow-sm" role="alert">
            <small class="text-muted"><i class="fas fa-shield-alt me-1"></i> Segurança: O arquivo é processado na memória e descartado imediatamente. Nada fica salvo.</small>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 1. Mostrar nome do arquivo quando selecionar
    document.getElementById('{{ form.arquivo_pdf.id_for_label }}').addEventListener('change', function(e) {
        var fileName = e.target.files[0].name;
        var badge = document.getElementById('file-name');
        badge.textContent = fileName;
        badge.classList.remove('d-none');
    });

    // 2. Loading ao enviar
    document.getElementById('formCompressao').addEventListener('submit', function() {
        var btn = document.getElementById('btnComprimir');
        var loading = document.getElementById('loadingArea');
        
        btn.classList.add('d-none');
        loading.classList.remove('d-none');
        
        // Pequeno truque: recarrega a página após 3 segundos para limpar o form (já que é download)
        setTimeout(function(){
            btn.classList.remove('d-none');
            loading.classList.add('d-none');
            badge.classList.add('d-none');
        }, 5000);
    });
</script>
{% endblock %}