{% extends 'base.html' %}

{% block title %}Gerador de Documentos{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
{% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-md-8">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-file-signature me-2"></i> Gerador de Documentos</h5>
            </div>
            <div class="card-body p-4">
                <form action="{% url 'imprimir_documento' %}" method="POST" target="_blank" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold">Selecione o Documento:</label>
                        <select name="tipo_documento" id="tipo_documento" class="form-select form-select-lg" onchange="toggleCamposExtras()">
                            <option value="procuracao">üìÑ Procura√ß√£o Despachante</option>
                            <option value="procuracao_atpv">üöô Procura√ß√£o ATPV-e (Inten√ß√£o de Venda)</option>
                            <option value="procuracao_particular">‚öñÔ∏è Procura√ß√£o Particular (Compra/Venda)</option>
                            <option value="declaracao">üè† Declara√ß√£o de Resid√™ncia</option>
                            <option value="requerimento_2via">üöó Requerimento 2¬™ Via CRV/CRLV</option>
                            <option value="alteracao_caracteristica">üõ†Ô∏è Altera√ß√£o de Caracter√≠sticas</option>
                            <option value="requerimento_baixa">üìâ Requerimento de Baixa de Ve√≠culo (RQ14)</option>
                            
                            <option value="termo_fotografico_veiculo">üì∏ Termo Fotogr√°fico do Ve√≠culo (Anexo I)</option>
                            <option value="termo_fotografico_placas">üì∏ Termo Inutiliza√ß√£o Placas/Chassi (Anexo II)</option>
                            
                            <option value="recibo">üí∞ Recibo de Pagamento</option>
                            <option value="contrato">ü§ù Contrato de Presta√ß√£o de Servi√ßo</option>
                            <option value="alteracao_endereco">üè† Requerimento de Altera√ß√£o de Endere√ßo</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Cliente / Outorgante:</label>
                        <select name="cliente_id" id="select_cliente" class="form-select" required>
                            <option value="">Digite 3 letras para pesquisar...</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Ve√≠culo:</label>
                        <select name="veiculo_placa" id="select_veiculo" class="form-select">
                            <option value="">Primeiro selecione um cliente...</option>
                        </select>
                    </div>

                    <div id="box_baixa" class="card bg-light border p-3 mb-3 d-none">
                        <h6 class="text-danger border-bottom pb-2 fw-bold mb-3">Dados para Baixa</h6>
                        
                        <label class="form-label fw-bold small text-uppercase">Identifica√ß√£o do Solicitante:</label>
                        <div class="d-flex flex-wrap gap-3 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipo_solicitante_baixa" value="proprietario" id="baixa_proprietario" checked>
                                <label class="form-check-label" for="baixa_proprietario">Propriet√°rio do ve√≠culo</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipo_solicitante_baixa" value="adquirente" id="baixa_adquirente">
                                <label class="form-check-label" for="baixa_adquirente">Adquirente</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipo_solicitante_baixa" value="representante" id="baixa_representante">
                                <label class="form-check-label" for="baixa_representante">Representante Legal</label>
                            </div>
                        </div>

                        <div class="bg-white p-2 border rounded mb-3">
                            <label class="form-label fw-bold small text-muted mb-1">Possui Procurador? (Autom√°tico)</label>
                            <div class="d-flex gap-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="possui_procurador_baixa" value="sim" id="proc_sim">
                                    <label class="form-check-label fw-bold text-primary" for="proc_sim">SIM</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="possui_procurador_baixa" value="nao" id="proc_nao" checked>
                                    <label class="form-check-label fw-bold text-secondary" for="proc_nao">N√ÉO</label>
                                </div>
                            </div>
                        </div>

                        <label class="form-label fw-bold small text-uppercase">Motivo da Baixa:</label>
                        <select name="motivo_baixa" class="form-select">
                            <option value="irrecuperavel">Ve√≠culo Irrecuper√°vel</option>
                            <option value="desmontado">Ve√≠culo Definitivamente Desmontado</option>
                            <option value="sinistrado">Ve√≠culo Sinistrado (Perda Total / Grande Monta)</option>
                            <option value="sucata">Ve√≠culo Vendido/Leiloado como Sucata</option>
                            <option value="frota">Frota Desativada (N√£o licenciado h√° 10 anos)</option>
                        </select>
                    </div>

                    <div id="box_fotos" class="card bg-light border p-3 mb-3 d-none">
                        <h6 class="text-success border-bottom pb-2 fw-bold mb-3"><i class="fas fa-camera me-2"></i> Upload das Fotos</h6>
                        <div class="alert alert-info small py-2 mb-3">
                            <i class="fas fa-info-circle me-1"></i> As fotos ser√£o inseridas automaticamente no documento PDF.
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold small text-muted" id="lbl_foto1">Foto 1</label>
                                <input type="file" name="foto1" class="form-control" accept="image/*">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small text-muted" id="lbl_foto2">Foto 2</label>
                                <input type="file" name="foto2" class="form-control" accept="image/*">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small text-muted" id="lbl_foto3">Foto 3</label>
                                <input type="file" name="foto3" class="form-control" accept="image/*">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small text-muted" id="lbl_foto4">Foto 4</label>
                                <input type="file" name="foto4" class="form-control" accept="image/*">
                            </div>
                        </div>
                    </div>

                    <div id="box_atpv" class="card bg-light border p-3 mb-3 d-none">
                        <h6 class="text-primary border-bottom pb-2 fw-bold mb-3">Dados da Transa√ß√£o (ATPV-e)</h6>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Quem √© o Comprador?</label>
                            <select name="comprador_id" id="select_comprador" class="form-select w-100">
                                <option value="">Busque o Comprador no sistema...</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold text-success">Valor Venda (R$):</label>
                                <input type="text" name="valor_venda" id="input_valor_venda" class="form-control" placeholder="0,00" onkeyup="formatarMoeda(this)">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">N¬∫ do CRV:</label>
                                <input type="text" name="numero_crv" id="input_crv" class="form-control" placeholder="Ex: 123456789">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">N¬∫ ATPV-e:</label>
                                <input type="text" name="numero_atpv" id="input_atpv" class="form-control" placeholder="Opcional">
                            </div>
                        </div>
                    </div>

                    <div id="box_outorgado" class="card bg-light border p-3 mb-3 d-none">
                        <label class="form-label fw-bold text-dark border-bottom pb-2 w-100">Quem ser√° o Procurador (Outorgado)?</label>
                        <div class="d-flex gap-4 mb-3 mt-2">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipo_outorgado" id="out_escritorio" value="escritorio" checked>
                                <label class="form-check-label fw-bold" for="out_escritorio">
                                    üè¢ Meu Escrit√≥rio (Padr√£o)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipo_outorgado" id="out_outro" value="outro">
                                <label class="form-check-label fw-bold text-primary" for="out_outro">
                                    üë§ Outra Pessoa (Buscar)
                                </label>
                            </div>
                        </div>
                        <div id="div_busca_outorgado" class="d-none animate__animated animate__fadeIn">
                            <label class="small text-muted mb-1">Pesquise abaixo quem receber√° os poderes (ex: Comprador):</label>
                            <select name="outorgado_id" id="select_outorgado" class="form-select w-100">
                                <option value="">Digite Nome ou CPF do Outorgado...</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3 d-none" id="campo_valor">
                        <label class="form-label fw-bold text-success">Valor (R$):</label>
                        <input type="text" name="valor_recibo" id="input_valor" class="form-control form-control-lg" placeholder="0,00" onkeyup="formatarMoeda(this)">
                    </div>
                    <div class="mb-3 d-none" id="campo_motivo">
                        <label class="form-label fw-bold text-danger">Motivo (2¬™ Via):</label>
                        <input type="text" name="motivo_2via" id="input_motivo" class="form-control" placeholder="Ex: Perda, Extravio...">
                    </div>
                    <div class="mb-3 d-none" id="campo_alteracao">
                        <label class="form-label fw-bold text-primary">Descri√ß√£o da Altera√ß√£o:</label>
                        <input type="text" name="alteracao_pretendida" id="input_alteracao" class="form-control" placeholder="Ex: Mudan√ßa de Cor...">
                    </div>
                    <div class="mb-4" id="campo_servicos">
                        <label class="form-label fw-bold d-block" id="label_servicos">Servi√ßos / Referente a:</label>
                        <div class="card p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                            {% for servico in servicos %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="servicos_selecionados" value="{{ servico.id }}" id="serv_{{ servico.id }}">
                                    <label class="form-check-label" for="serv_{{ servico.id }}">{{ servico.nome }}</label>
                                </div>
                            {% empty %}
                                <span class="text-muted small">Nenhum servi√ßo cadastrado.</span>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-print me-2"></i> Gerar e Imprimir
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function() {
        
        // --- CONFIGURA√á√ÉO SELECT2 (Server-Side Search) ---
        // Garante que s√≥ busca no banco quando o usu√°rio digita
        var configSelect2 = {
            theme: 'bootstrap-5',
            width: '100%',
            language: {
                inputTooShort: function() { return "Digite 3 caracteres..."; },
                noResults: function() { return "Nenhum cadastro encontrado."; },
                searching: function() { return "Buscando..."; }
            },
            ajax: {
                url: '{% url "buscar_clientes" %}', // Chama a View que usa Q()
                dataType: 'json',
                delay: 300,
                data: function (params) {
                    return { term: params.term }; // Envia o que foi digitado
                },
                processResults: function (data) {
                    return { results: data.results }; // Recebe o JSON filtrado
                },
                cache: true
            },
            minimumInputLength: 3 // Evita carregar todos os clientes de uma vez
        };

        $('#select_cliente').select2({ ...configSelect2, placeholder: 'Busque o Cliente (Nome ou CPF)...' });
        $('#select_outorgado').select2({ ...configSelect2, placeholder: 'Busque o Procurador (Outorgado)...' });
        $('#select_comprador').select2({ ...configSelect2, placeholder: 'Busque o Comprador...' });

        // Ao selecionar cliente -> Carrega Ve√≠culos
        $('#select_cliente').on('select2:select', function (e) {
            carregarVeiculos(e.params.data.id);
        });

        // L√≥gica do Outorgado
        $('input[name="tipo_outorgado"]').change(function() {
            if ($('#out_outro').is(':checked')) {
                $('#div_busca_outorgado').removeClass('d-none');
            } else {
                $('#div_busca_outorgado').addClass('d-none');
                $('#select_outorgado').val(null).trigger('change'); 
            }
        });

        // Automa√ß√£o da Baixa de Ve√≠culo
        $('input[name="tipo_solicitante_baixa"]').change(function() {
            var tipo = $(this).val();
            if (tipo === 'representante') {
                $('#proc_sim').prop('checked', true);
                $('#box_outorgado').removeClass('d-none');
            } else {
                $('#proc_nao').prop('checked', true);
                $('#box_outorgado').addClass('d-none');
            }
        });

        // Inicializa estado dos campos
        $('input[name="tipo_outorgado"]:checked').trigger('change');
        toggleCamposExtras();
    });

    function toggleCamposExtras() {
        const tipo = document.getElementById('tipo_documento').value;
        const divs = ['campo_motivo', 'campo_alteracao', 'campo_servicos', 'campo_valor', 'box_outorgado', 'box_atpv', 'box_baixa', 'box_fotos'];
        const inputsRequired = ['input_motivo', 'input_alteracao', 'input_valor', 'input_valor_venda', 'input_crv']; 
        const labelServicos = document.getElementById('label_servicos');

        // 1. Esconde tudo
        divs.forEach(id => document.getElementById(id).classList.add('d-none'));
        inputsRequired.forEach(id => { 
            let el = document.getElementById(id); 
            if(el) el.required = false; 
        });

        // 2. Mostra o necess√°rio
        if (tipo === 'requerimento_2via') {
            document.getElementById('campo_motivo').classList.remove('d-none');
        } 
        else if (tipo === 'alteracao_caracteristica') {
            document.getElementById('campo_alteracao').classList.remove('d-none');
            document.getElementById('input_alteracao').required = true;
        }
        else if (tipo === 'procuracao') {
            document.getElementById('campo_servicos').classList.remove('d-none');
            labelServicos.innerText = "Servi√ßos a Solicitar (Para Procura√ß√£o):";
        }
        else if (tipo === 'recibo') {
            document.getElementById('campo_valor').classList.remove('d-none');
            document.getElementById('input_valor').required = true;
            document.getElementById('campo_servicos').classList.remove('d-none');
            labelServicos.innerText = "Referente aos servi√ßos:";
        }
        else if (tipo === 'contrato') {
            document.getElementById('campo_valor').classList.remove('d-none');
            document.getElementById('campo_servicos').classList.remove('d-none');
            labelServicos.innerText = "Objeto do Contrato:";
        }
        else if (tipo === 'procuracao_particular') {
            document.getElementById('box_outorgado').classList.remove('d-none');
        }
        else if (tipo === 'procuracao_atpv') {
            document.getElementById('box_atpv').classList.remove('d-none');
            document.getElementById('input_valor_venda').required = true;
        }
        else if (tipo === 'requerimento_baixa') {
            document.getElementById('box_baixa').classList.remove('d-none');
            if ($('#baixa_representante').is(':checked')) {
                $('#box_outorgado').removeClass('d-none');
            }
        }
        // REGRAS PARA FOTOS
        else if (tipo === 'termo_fotografico_veiculo') {
            document.getElementById('box_fotos').classList.remove('d-none');
            $('#lbl_foto1').text('1. Dianteira + Lateral Esquerda (45¬∞)');
            $('#lbl_foto2').text('2. Dianteira + Lateral Direita (45¬∞)');
            $('#lbl_foto3').text('3. Traseira + Lateral Esquerda (45¬∞)');
            $('#lbl_foto4').text('4. Traseira + Lateral Direita (45¬∞)');
        }
        else if (tipo === 'termo_fotografico_placas') {
            document.getElementById('box_fotos').classList.remove('d-none');
            $('#lbl_foto1').text('1. Estrutura com grava√ß√£o do chassi');
            $('#lbl_foto2').text('2. Estrutura ap√≥s remo√ß√£o do chassi');
            $('#lbl_foto3').text('3. Grava√ß√£o removida (Recorte)');
            $('#lbl_foto4').text('4. Placas cortadas ao meio');
        }
    }

    function carregarVeiculos(clienteId) {
        const selectVeiculo = $('#select_veiculo');
        selectVeiculo.empty().append('<option value="">Carregando...</option>');
        
        if(!clienteId) return;

        $.ajax({
            url: `/api/veiculos-cliente/${clienteId}/`,
            method: 'GET',
            success: function(data) {
                selectVeiculo.empty();
                if (data.length === 0) {
                    selectVeiculo.append('<option value="">Nenhum ve√≠culo cadastrado</option>');
                } else {
                    selectVeiculo.append('<option value="">-- Selecione o Ve√≠culo --</option>');
                    data.forEach(function(v) {
                        selectVeiculo.append(`<option value="${v.placa}">${v.placa} - ${v.modelo}</option>`);
                    });
                }
            },
            error: function() {
                selectVeiculo.empty().append('<option value="">Erro ao buscar ve√≠culos</option>');
            }
        });
    }

    function formatarMoeda(i) {
        var v = i.value.replace(/\D/g,'');
        v = (v/100).toFixed(2) + '';
        v = v.replace(".", ",");
        v = v.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
        v = v.replace(/(\d)(\d{3}),/g, "$1.$2,");
        i.value = v;
    }
</script>
{% endblock %}