{% extends 'base.html' %}
{% load static %}

{% block title %}Novo Orçamento{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<style>
    .select2-container--bootstrap-5 .select2-selection {
        min-height: 38px;
        padding-top: 4px;
    }
    /* Destaque para o campo de honorários (o campo verde) */
    .input-honorario-destaque {
        font-weight: bold;
        color: #198754;
        background-color: #f8fff9 !important;
    }
    .bg-dark-custom {
        background-color: #212529 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        
        <form method="post" id="form-orcamento">
            {% csrf_token %}
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold mb-0 text-dark">
                    <i class="fas fa-file-invoice-dollar text-success me-2"></i> Novo Orçamento
                </h2>
                <a href="{% url 'listar_orcamentos' %}" class="btn btn-outline-secondary">Cancelar</a>
            </div>

            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0 text-primary">1. Destinatário e Veículo</h6>
                    
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="switch_cliente_avulso">
                        <label class="form-check-label small fw-bold user-select-none" for="switch_cliente_avulso">
                            Cliente não cadastrado?
                        </label>
                    </div>
                </div>
                
                <div class="card-body">
                    <div id="container_busca_banco">
                        <label class="form-label small fw-bold text-muted text-uppercase">Buscar Cliente Cadastrado</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                            <select name="cliente_id" id="select_cliente_orcamento" class="form-select">
                                <option value="">Digite Nome, CPF/CNPJ ou Placa...</option>
                            </select>
                        </div>
                    </div>

                    <div id="container_cliente_avulso" class="d-none">
                        <label class="form-label small fw-bold text-muted text-uppercase">Nome do Cliente (Avulso)</label>
                        <div class="input-group">
                            <span class="input-group-text bg-warning border-end-0 text-dark"><i class="fas fa-user-edit"></i></span>
                            <input type="text" name="cliente_nome_avulso" id="input_nome_avulso" 
                                   class="form-control border-start-0 bg-light" placeholder="Digite o nome para o orçamento...">
                        </div>
                    </div>

                    <div id="container_veiculo_orcamento" class="d-none mt-3 animate__animated animate__fadeIn">
                        <hr class="text-muted opacity-25 my-3">
                        <label class="form-label small fw-bold text-primary text-uppercase">
                            <i class="fas fa-car me-1"></i> Veículo (Opcional)
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-white text-primary"><i class="fas fa-car-side"></i></span>
                            <select name="veiculo_id" id="select_veiculo_orcamento" class="form-select">
                                <option value="">-- Selecione um Veículo --</option>
                            </select>
                            <button type="button" class="btn btn-outline-secondary" id="btn_limpar_veiculo">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3">
                    <h6 class="fw-bold mb-0 text-primary">2. Itens / Taxas do Detran</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover align-middle mb-0" id="tabela-itens">
                        <thead class="table-light small text-center">
                            <tr>
                                <th class="text-start ps-4">Descrição do Item</th>
                                <th width="180px">Custo (Taxa R$)</th>
                                <th width="50px"></th>
                            </tr>
                        </thead>
                        <tbody id="lista_itens_adicionados">
                            </tbody>
                        <tfoot class="bg-light">
                            <tr>
                                <td colspan="3" class="p-3">
                                    <label class="small text-muted fw-bold mb-1">Adicionar Item (Taxa):</label>
                                    <div class="input-group">
                                        <input class="form-control" list="datalistOptions" id="input_busca_servico" placeholder="Busque o serviço...">
                                        <datalist id="datalistOptions">
                                            {% for servico in servicos %}
                                                <option value="{{ servico.nome }}" 
                                                        data-id="{{ servico.id }}" 
                                                        data-taxa="{{ servico.valor_base }}">
                                                </option>
                                            {% endfor %}
                                        </datalist>
                                        <button type="button" class="btn btn-primary px-4" id="btn-add-item">
                                            <i class="fas fa-plus me-1"></i> Adicionar
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-5 bg-dark-custom text-white">
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <label class="form-label small text-white-50 fw-bold">Observações do Orçamento</label>
                            <textarea name="observacoes" class="form-control bg-secondary text-white border-0" rows="5" placeholder="Ex: Válido por 5 dias, forma de pagamento..."></textarea>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between mb-3 text-white-50 small align-items-center border-bottom border-secondary pb-2">
                                <span>Total Taxas (Detran/Outros):</span>
                                <span class="fs-5 text-white fw-bold" id="lbl_taxas">R$ 0,00</span>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small text-success fw-bold text-uppercase d-flex justify-content-between">
                                    <span><i class="fas fa-hand-holding-usd me-1"></i> Seus Honorários</span>
                                    <span class="text-white-50" style="text-transform: none; font-weight: normal;">(Pelo serviço)</span>
                                </label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text bg-success text-white border-0 fw-bold">R$</span>
                                    <input type="text" name="honorarios_total" id="input_honorarios_total" 
                                           class="form-control input-honorario-destaque text-end mask-money"
                                           value="{{ user.perfilusuario.despachante.valor_honorario_padrao|floatformat:2 }}" required>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <span class="text-white-50 small">Desconto no Total (R$):</span>
                                <div class="input-group input-group-sm w-50">
                                    <span class="input-group-text bg-secondary text-white border-0">R$</span>
                                    <input type="text" name="desconto" id="input_desconto" 
                                           class="form-control bg-secondary text-white border-0 text-end mask-money" placeholder="0,00">
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between fs-2 fw-bold text-success mt-2 p-3 bg-white rounded shadow-lg animate__animated animate__pulse animate__infinite">
                                <span class="text-dark">TOTAL:</span>
                                <span id="lbl_total">R$ 0,00</span>
                                <input type="hidden" id="valor_total_hidden" value="0.00">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer border-0 bg-success p-0">
                    <button type="submit" class="btn btn-success w-100 py-3 fw-bold fs-5 rounded-0 rounded-bottom">
                        <i class="fas fa-check-circle me-2"></i> FINALIZAR E GERAR ORÇAMENTO
                    </button>
                </div>
            </div>

        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function() {
        
        // --- MÁSCARAS ---
        $('.mask-money').mask('#.##0,00', {reverse: true});

        let totalTaxasGlobal = 0.00;

        // --- FUNÇÕES DE CONVERSÃO ---
        function parseMoney(valor) {
            if (!valor) return 0;
            let limpo = valor.toString().replace(/\./g, '').replace(',', '.');
            return parseFloat(limpo) || 0;
        }

        function formatMoney(valor) {
            return valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // --- CÁLCULO DINÂMICO ---
        function atualizarTotais() {
            const honorarios = parseMoney($('#input_honorarios_total').val());
            const desconto = parseMoney($('#input_desconto').val());

            const subtotal = totalTaxasGlobal + honorarios;
            let totalFinal = subtotal - desconto;
            
            if(totalFinal < 0) totalFinal = 0;

            $('#lbl_taxas').text('R$ ' + formatMoney(totalTaxasGlobal));
            $('#lbl_total').text('R$ ' + formatMoney(totalFinal));
            $('#valor_total_hidden').val(totalFinal.toFixed(2));
        }

        $('#input_honorarios_total, #input_desconto').on('input', atualizarTotais);

        // --- ADICIONAR ITEM ---
        $('#btn-add-item').on('click', function() {
            const input = document.getElementById('input_busca_servico');
            const datalist = document.getElementById('datalistOptions');
            const valorDigitado = input.value;
            
            let servicoSelecionado = null;
            for (let i = 0; i < datalist.options.length; i++) {
                if (datalist.options[i].value === valorDigitado) {
                    servicoSelecionado = datalist.options[i];
                    break;
                }
            }

            if (!servicoSelecionado) {
                alert("Por favor, selecione um serviço da lista.");
                return;
            }

            const id = servicoSelecionado.getAttribute('data-id');
            const nome = servicoSelecionado.value;
            let taxaRaw = servicoSelecionado.getAttribute('data-taxa'); 
            const taxa = parseMoney(taxaRaw);

            adicionarLinhaTabela(id, nome, taxa);
            input.value = '';
            input.focus();
        });

        function adicionarLinhaTabela(id, nome, taxa) {
            const tbody = document.getElementById('lista_itens_adicionados');
            const row = document.createElement('tr');

            row.innerHTML = `
                <td class="ps-4 text-start">
                    <span class="fw-bold text-dark">${nome}</span>
                    <input type="hidden" name="servicos[]" value="${id}">
                    <input type="hidden" name="taxas_item[]" value="${formatMoney(taxa)}">
                </td>
                <td class="text-center fw-bold text-muted">
                    R$ ${formatMoney(taxa)}
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm text-danger btn-remove" data-taxa="${taxa}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

            tbody.appendChild(row);
            totalTaxasGlobal += taxa;
            atualizarTotais();
        }

        $(document).on('click', '.btn-remove', function() {
            const taxa = parseFloat($(this).data('taxa'));
            $(this).closest('tr').remove();
            totalTaxasGlobal -= taxa;
            if(totalTaxasGlobal < 0) totalTaxasGlobal = 0;
            atualizarTotais();
        });

        // --- 1. CONFIGURAÇÃO DO SELECT2 PARA CLIENTE (COM AJAX) ---
        $('#select_cliente_orcamento').select2({
            theme: 'bootstrap-5',
            ajax: {
                url: "{% url 'buscar_clientes' %}", 
                dataType: 'json',
                delay: 250,
                data: function (params) { return { term: params.term }; },
                processResults: function (data) { return { results: data.results }; },
                cache: true
            },
            minimumInputLength: 3,
            placeholder: 'Digite nome, CPF ou placa...'
        });

        // --- 2. CONFIGURAÇÃO DO SELECT2 PARA VEÍCULO (BUSCA DINÂMICA) ---
        // Inicializa o Select2 vazio, mas pronto para busca local
        $('#select_veiculo_orcamento').select2({
            theme: 'bootstrap-5',
            placeholder: '-- Selecione um Veículo --',
            allowClear: true,
            language: {
                noResults: function() { return "Nenhum veículo encontrado"; }
            }
        });

        // --- CARREGAR VEÍCULOS AO SELECIONAR CLIENTE ---
        $('#select_cliente_orcamento').on('select2:select', function (e) {
            const clienteId = e.params.data.id;
            $('#container_veiculo_orcamento').removeClass('d-none');
            const selectVeiculo = $('#select_veiculo_orcamento');
            
            // Limpa e avisa que está carregando
            selectVeiculo.empty().append('<option value="">Carregando...</option>');
            selectVeiculo.trigger('change'); // Atualiza visual

            $.getJSON('/api/veiculos-cliente/' + clienteId + '/', function(veiculos) {
                selectVeiculo.empty().append('<option value="">-- Selecione um Veículo --</option>');
                
                if (veiculos.length === 0) {
                    selectVeiculo.append('<option value="" disabled>Nenhum veículo encontrado</option>');
                }

                veiculos.forEach(v => {
                    let textoOpcao = `${v.placa} - ${v.modelo}`;
                    if (v.proprietario_nome) {
                        textoOpcao += ` (Prop: ${v.proprietario_nome})`;
                    }
                    selectVeiculo.append(new Option(textoOpcao, v.id));
                });

                // --- PULO DO GATO: AVISA O SELECT2 QUE A LISTA MUDOU ---
                selectVeiculo.trigger('change'); 
            })
            .fail(function() {
                selectVeiculo.empty().append('<option value="">Erro ao carregar</option>');
                selectVeiculo.trigger('change');
            });
        });

        // Botão para limpar veículo selecionado
        $('#btn_limpar_veiculo').on('click', function() {
            $('#select_veiculo_orcamento').val(null).trigger('change');
        });

        // Alternar Cliente Avulso
        $('#switch_cliente_avulso').on('change', function() {
            if (this.checked) {
                $('#container_busca_banco, #container_veiculo_orcamento').addClass('d-none');
                $('#container_cliente_avulso').removeClass('d-none');
                $('#select_cliente_orcamento').val(null).trigger('change');
            } else {
                $('#container_busca_banco').removeClass('d-none');
                $('#container_cliente_avulso').addClass('d-none');
            }
        });

        atualizarTotais();
    });
</script>
{% endblock %}