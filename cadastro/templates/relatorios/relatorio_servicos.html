{% extends 'base.html' %}

{% block title %}Extrato Final por Cliente{% endblock %}

{% block content %}
<div class="d-print-none mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0 fw-bold text-dark"><i class="fas fa-file-invoice-dollar text-success me-2"></i> Extrato de Serviços Concluídos</h4>
        {% if relatorio_agrupado %}
        <button onclick="window.print()" class="btn btn-dark btn-sm shadow-sm">
            <i class="fas fa-print me-2"></i> Imprimir Extrato
        </button>
        {% endif %}
    </div>

    <div class="card shadow-sm border-0 bg-light">
        <div class="card-body py-3">
            <form method="GET" class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Nome do Cliente ou Placa</label>
                    <input type="text" name="cliente_placa" class="form-control form-control-sm" 
                           placeholder="Ex: João Silva ou ABC1D23" value="{{ filtros.cliente_placa|default:'' }}" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold text-muted">Início</label>
                    <input type="date" name="data_inicio" class="form-control form-control-sm" value="{{ filtros.data_inicio|default:'' }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold text-muted">Fim</label>
                    <input type="date" name="data_fim" class="form-control form-control-sm" value="{{ filtros.data_fim|default:'' }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label small fw-bold text-muted">Situação Financeira</label>
                    <select name="status_financeiro" class="form-select form-select-sm">
                        <option value="">Todas as situações</option>
                        <option value="ABERTO" {% if filtros.status_financeiro == 'ABERTO' %}selected{% endif %}>Aguardando Pagamento</option>
                        <option value="PAGO" {% if filtros.status_financeiro == 'PAGO' %}selected{% endif %}>Já Pagos</option>
                    </select>
                </div>
                <div class="col-md-2 d-grid">
                    <button type="submit" class="btn btn-primary btn-sm fw-bold">
                        <i class="fas fa-search me-1"></i> Gerar Relatório
                    </button>
                </div>
            </form>
            <div class="form-text mt-2 small text-muted">
                <i class="fas fa-shield-check me-1 text-success"></i> Segurança: Apenas serviços com status <strong>CONCLUÍDO</strong> são listados para cobrança.
            </div>
        </div>
    </div>
</div>

<div class="print-header text-center mb-2" style="display: none;">
    
    <div class="mb-2">
        {% if user.perfilusuario.despachante.logo %}
            <img src="{{ user.perfilusuario.despachante.logo.url }}" alt="Logo" style="max-height: 90px; max-width: 90%; margin-bottom: 2px;">
        {% else %}
            <h2 class="fw-bold text-uppercase text-dark mb-0">
                {{ user.perfilusuario.despachante.nome_fantasia|default:"SEU DESPACHANTE" }}
            </h2>
        {% endif %}
    </div>

    <p class="text-muted small mb-2" style="font-size: 0.85rem;">
        {{ user.perfilusuario.despachante.endereco_completo }} <br>
        <i class="fas fa-phone-alt me-1"></i> {{ user.perfilusuario.despachante.telefone }} 
        {% if user.perfilusuario.despachante.email %}
            | <i class="fas fa-envelope me-1"></i> {{ user.perfilusuario.despachante.email }}
        {% endif %}
    </p>

    <div class="border-top border-bottom py-1">
        <h5 class="fw-bold text-uppercase mb-1 mt-1">Extrato Final de Serviços e Honorários</h5>
        <div class="row small text-muted">
            <div class="col-6 text-start">
                <strong>Período:</strong> 
                {% if filtros.data_inicio %}{{ filtros.data_inicio|date:"d/m/Y" }}{% else %}Início{% endif %} até {% if filtros.data_fim %}{{ filtros.data_fim|date:"d/m/Y" }}{% else %}Hoje{% endif %}
            </div>
            <div class="col-6 text-end">
                <strong>Emissão:</strong> {% now "d/m/Y H:i" %}
            </div>
        </div>
    </div>
</div>

<div id="area-relatorio">
    {% if relatorio_agrupado %}
        
        {% for cliente_id, dados in relatorio_agrupado.items %}
        <div class="cliente-container mb-4 pb-3 border-bottom">
            
            <div class="mb-2 d-flex justify-content-between align-items-start">
                <div>
                    <h5 class="fw-bold mb-0 text-uppercase text-primary">{{ dados.dados_cliente.nome }}</h5>
                    <small class="text-muted">
                        CPF/CNPJ: {{ dados.dados_cliente.cpf_cnpj|default:"--" }} 
                        {% if dados.dados_cliente.telefone %} • Tel: {{ dados.dados_cliente.telefone }} {% endif %}
                    </small>
                </div>
                
                <div class="btn-group d-print-none">
                    {% if dados.telefone_limpo %}
                    <a href="https://wa.me/55{{ dados.telefone_limpo }}?text={{ dados.texto_whatsapp|urlencode }}" 
                       target="_blank" 
                       class="btn btn-outline-success btn-sm fw-bold"
                       title="Enviar lista no WhatsApp">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </a>
                    {% endif %}

                    {% if dados.subtotal_aberto > 0 %}
                        <form action="{% url 'gerar_boleto_agrupado' cliente_id %}" method="POST" class="d-inline ms-1"
                              onsubmit="return confirm('ATENÇÃO: Você está gerando um boleto de R$ {{ dados.subtotal_aberto|floatformat:2 }} apenas para os itens pendentes. Continuar?');">
                            {% csrf_token %}
                            
                            {% for item in dados.itens %}
                                {% if item.status_code == 'ABERTO' %}
                                    <input type="hidden" name="atendimentos_ids" value="{{ item.id }}">
                                {% endif %}
                            {% endfor %}
                            
                            <button type="submit" class="btn btn-primary btn-sm fw-bold" title="Gerar Boleto Único (Asaas)">
                                <i class="fas fa-barcode me-1"></i> Cobrar R$ {{ dados.subtotal_aberto|floatformat:2 }}
                            </button>
                        </form>
                    
                    {% elif dados.subtotal_valor > 0 %}
                        <button class="btn btn-secondary btn-sm fw-bold ms-1" disabled title="Todos os itens deste cliente já constam como PAGOS">
                            <i class="fas fa-check-double me-1"></i> Quitado
                        </button>
                    {% endif %}
                    </div>
            </div>

            <table class="table table-sm table-borderless mb-0 custom-print-table">
                <thead style="border-bottom: 2px solid #000;">
                    <tr class="text-uppercase small fw-bold">
                        <td width="10%">Data</td>
                        <td width="20%">Veículo / Processo</td> 
                        <td width="25%">Descrição do Serviço</td>
                        <td width="12%" class="text-end">Taxas DETRAN</td>
                        <td width="12%" class="text-end">Honorários</td>
                        <td width="21%" class="text-end">Total Item</td> </tr>
                </thead>
                <tbody>
                    {% for item in dados.itens %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td class="align-middle">{{ item.data|date:"d/m/Y" }}</td>
                        <td class="align-middle">
                            <strong>{{ item.placa }}</strong>
                            
                            {% if item.proprietario_nome %}
                                <div class="text-danger fw-bold small mt-1" style="font-size: 0.7rem; line-height: 1.1;">
                                    <i class="fas fa-user-tag me-1"></i>{{ item.proprietario_nome }}
                                </div>
                            {% endif %}

                            <div class="mt-1">
                                <span class="badge bg-light text-muted border small p-1">
                                    <i class="fas fa-hashtag me-1"></i>{{ item.numero_atendimento|default:"S/N" }}
                                </span>
                            </div>
                        </td>
                        <td class="align-middle">
                            {{ item.servico_nome }}<br>
                            <small class="text-muted" style="font-size: 0.75rem;">{{ item.modelo|truncatechars:25 }}</small>
                        </td>
                        <td class="text-end align-middle">R$ {{ item.taxas|floatformat:2 }}</td>
                        <td class="text-end align-middle">R$ {{ item.honorario|floatformat:2 }}</td>
                        
                        <td class="text-end align-middle">
                            <span class="fw-bold text-dark">R$ {{ item.valor_total|floatformat:2 }}</span>
                            
                            {% if item.status_code == 'PAGO' %}
                                <i class="fas fa-check-circle text-success ms-1" title="Pago"></i>
                            {% elif item.asaas_id %}
                                <i class="fas fa-barcode text-warning ms-1" title="Boleto Gerado (Aguardando Pagamento)"></i>
                            {% endif %}
                            
                            <a href="{% url 'emitir_recibo' item.id %}" target="_blank" 
                               class="btn btn-sm btn-link text-secondary p-0 ms-2 d-print-none" 
                               title="Imprimir Recibo Individual">
                                <i class="fas fa-print"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="fw-bold">
                        <td colspan="3" class="text-end pe-3 small text-uppercase pt-2">Subtotal do Cliente:</td>
                        <td class="text-end border-top border-dark pt-2 text-danger">R$ {{ dados.subtotal_taxas|floatformat:2 }}</td>
                        <td class="text-end border-top border-dark pt-2">R$ {{ dados.subtotal_honorarios|floatformat:2 }}</td>
                        <td class="text-end border-top border-dark pt-2 bg-light">R$ {{ dados.subtotal_valor|floatformat:2 }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% endfor %}

        <div class="resumo-geral mt-4 p-3 border border-dark rounded break-inside-avoid bg-light">
            <h6 class="fw-bold text-uppercase border-bottom pb-2 mb-3">Resumo Geral do Extrato Final</h6>
            <div class="row text-center">
                <div class="col-4">
                    <span class="d-block text-muted small text-uppercase">Total Repasse (Taxas)</span>
                    <h4 class="fw-bold text-danger">R$ {{ total_geral_taxas|floatformat:2 }}</h4>
                </div>
                <div class="col-4">
                    <span class="d-block text-muted small text-uppercase">Total Serviços</span>
                    <h4 class="fw-bold">R$ {{ total_geral_honorarios|floatformat:2 }}</h4>
                </div>
                <div class="col-4">
                    <span class="d-block text-muted small text-uppercase">Total a Receber</span>
                    <h3 class="fw-bold text-success">R$ {{ total_geral_valor|floatformat:2 }}</h3>
                </div>
            </div>
        </div>

    {% elif filtros.cliente_placa %}
        <div class="text-center py-5 text-muted border rounded mt-4 d-print-none bg-white shadow-sm">
            <i class="fas fa-search fa-3x mb-3 opacity-25"></i>
            <h5>Nenhum processo <strong>CONCLUÍDO</strong> encontrado.</h5>
            <p>Verifique o nome do cliente ou se os processos já foram finalizados (Status: Concluído) no operacional.</p>
        </div>
    {% else %}
        <div class="text-center py-5 mt-4 d-print-none border rounded bg-white shadow-sm">
            <div class="opacity-50">
                <i class="fas fa-file-invoice-dollar fa-4x mb-3 text-primary"></i>
                <h5>Extrato de Cobrança Final</h5>
                <p>Pesquise por um cliente para listar apenas os serviços <strong>concluídos</strong> prontos para pagamento.</p>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
    @media print {
        @page { size: A4; margin: 10mm 15mm; }
        body { background-color: #fff !important; font-family: Arial, sans-serif; font-size: 10pt; color: #000 !important; }
        
        .d-print-none, header, nav, footer, .btn, .card-header, form { display: none !important; }
        .print-header { display: block !important; margin-bottom: 10px !important; }
        
        .container, .container-fluid { width: 100% !important; padding: 0 !important; max-width: none !important; }
        
        /* Tabela Ajustada */
        .custom-print-table { width: 100% !important; border-collapse: collapse; }
        .custom-print-table td { padding: 4px 2px !important; border-bottom: 1px solid #ccc !important; font-size: 0.9rem; }
        
        /* Evita quebra de linha no meio da tabela */
        tr { page-break-inside: avoid; }
        
        /* Permite que o container do cliente quebre, mas tenta manter unido se for pequeno */
        .cliente-container { 
            page-break-inside: auto; 
            border-bottom: 2px solid #000 !important; 
            margin-bottom: 15px !important; 
        }

        .badge, .bg-light { border: none !important; color: #000 !important; padding: 0 !important; font-weight: bold; }
        .resumo-geral { border: 2px solid #000 !important; background-color: #eee !important; -webkit-print-color-adjust: exact; page-break-inside: avoid; }
        .text-primary, .text-success, .text-danger, .text-muted { color: #000 !important; }
    }
</style>
{% endblock %}